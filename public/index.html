<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Orders CRM</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #f2f2f2; }
    .hidden { display: none; }
    .btn { padding: 6px 12px; margin: 5px; background: #007bff; color: #fff; border: none; cursor: pointer; }
    .btn:hover { background: #0056b3; }
    .form-group { margin-bottom: 10px; }
    label { display: block; font-weight: bold; }
    input, select { width: 100%; padding: 6px; }
  </style>
</head>
<body>
  <h1>Orders CRM</h1>

  <!-- список -->
  <div id="listSection">
    <button id="newBtn" class="btn">+ New Order</button>
    <div id="orders"></div>
  </div>

  <!-- форма -->
  <div id="formSection" class="hidden">
    <div class="form-group"><label>Client</label><input id="client" /></div>
    <div class="form-group"><label>Status</label>
      <select id="status">
        <option>New</option><option>In Progress</option><option>Completed</option>
      </select>
    </div>
    <div class="form-group"><label>Currency</label><input id="currency" value="CNY"/></div>
    <div class="form-group"><label>Payment Terms</label><input id="payment_terms"/></div>
    <div class="form-group"><label>Logistics</label><input id="logistics"/></div>
    <div class="form-group"><label>Planned Start</label><input id="planned_start" type="date"/></div>
    <div class="form-group"><label>Planned End</label><input id="planned_end" type="date"/></div>
    <div class="form-group"><label>Actual Ship</label><input id="actual_ship" type="date"/></div>
    <div class="form-group"><label>Discount %</label><input id="discount_percent" type="number" value="0"/></div>
    <div class="form-group"><label>Extra Costs</label><input id="extra_costs" type="number" value="0"/></div>

    <h3>Items</h3>
    <table id="itemsTable">
      <thead>
        <tr>
          <th>Product</th><th>SKU</th><th>Color</th><th>Size</th>
          <th>Qty</th><th>Cost</th><th>Price</th><th>Disc%</th><th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="addItem" class="btn">+ Add Item</button><br/>

    <button id="saveBtn" class="btn">Save Order</button>
    <button id="cancelBtn" class="btn" style="background:#6c757d">Cancel</button>
  </div>

  <script>
    // --- состояние
    let editingId = null; // если null — создаём новый, если число — редактируем существующий

    const listSection = document.getElementById('listSection');
    const formSection = document.getElementById('formSection');
    const ordersDiv = document.getElementById('orders');
    const newBtn = document.getElementById('newBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveBtn');
    const addItemBtn = document.getElementById('addItem');
    const itemsTbody = document.querySelector('#itemsTable tbody');

    function row(item={}) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input value="${item.product||''}"/></td>
        <td><input value="${item.sku||''}"/></td>
        <td><input value="${item.color||''}"/></td>
        <td><input value="${item.size||''}"/></td>
        <td><input type="number" min="0" value="${item.quantity||0}"/></td>
        <td><input type="number" min="0" value="${item.cost||0}"/></td>
        <td><input type="number" min="0" value="${item.price||0}"/></td>
        <td><input type="number" min="0" value="${item.discount_percent||0}"/></td>
        <td><button class="btn">×</button></td>
      `;
      tr.querySelector('button').onclick = () => tr.remove();
      return tr;
    }

    function getFormPayload() {
      return {
        client: document.getElementById('client').value,
        status: document.getElementById('status').value,
        currency: document.getElementById('currency').value,
        payment_terms: document.getElementById('payment_terms').value,
        logistics: document.getElementById('logistics').value,
        planned_start: document.getElementById('planned_start').value,
        planned_end: document.getElementById('planned_end').value,
        actual_ship: document.getElementById('actual_ship').value,
        discount_percent: Number(document.getElementById('discount_percent').value||0),
        extra_costs: Number(document.getElementById('extra_costs').value||0),
        items: Array.from(itemsTbody.querySelectorAll('tr')).map(tr=>{
          const tds = tr.querySelectorAll('td');
          return {
            product: tds[0].querySelector('input').value,
            sku: tds[1].querySelector('input').value,
            color: tds[2].querySelector('input').value,
            size: tds[3].querySelector('input').value,
            quantity: Number(tds[4].querySelector('input').value||0),
            cost: Number(tds[5].querySelector('input').value||0),
            price: Number(tds[6].querySelector('input').value||0),
            discount_percent: Number(tds[7].querySelector('input').value||0),
          }
        })
      };
    }

    function clearForm() {
      editingId = null;
      document.getElementById('client').value = '';
      document.getElementById('status').value = 'New';
      document.getElementById('currency').value = 'CNY';
      document.getElementById('payment_terms').value = '';
      document.getElementById('logistics').value = '';
      document.getElementById('planned_start').value = '';
      document.getElementById('planned_end').value = '';
      document.getElementById('actual_ship').value = '';
      document.getElementById('discount_percent').value = '0';
      document.getElementById('extra_costs').value = '0';
      itemsTbody.innerHTML = '';
      saveBtn.textContent = 'Save Order';
    }

    function fillForm(order) {
      editingId = order.id;
      document.getElementById('client').value = order.client || '';
      document.getElementById('status').value = order.status || 'New';
      document.getElementById('currency').value = order.currency || 'CNY';
      document.getElementById('payment_terms').value = order.payment_terms || '';
      document.getElementById('logistics').value = order.logistics || '';
      document.getElementById('planned_start').value = order.planned_start || '';
      document.getElementById('planned_end').value = order.planned_end || '';
      document.getElementById('actual_ship').value = order.actual_ship || '';
      document.getElementById('discount_percent').value = order.discount_percent ?? 0;
      document.getElementById('extra_costs').value = order.extra_costs ?? 0;
      itemsTbody.innerHTML = '';
      (order.items || []).forEach(it => itemsTbody.appendChild(row(it)));
      if ((order.items || []).length === 0) itemsTbody.appendChild(row());
      saveBtn.textContent = 'Save Changes';
    }

    async function loadOrders() {
      const res = await fetch('/api/orders');
      const data = await res.json();
      ordersDiv.innerHTML = `
        <table>
          <thead><tr><th>#</th><th>Client</th><th>Status</th><th>Currency</th><th>Total</th><th>GP</th><th>Date</th></tr></thead>
          <tbody>
            ${data.map(o => `
              <tr data-id="${o.id}" style="cursor:pointer">
                <td>${o.order_number}</td>
                <td>${o.client||''}</td>
                <td>${o.status||''}</td>
                <td>${o.currency||''}</td>
                <td>${(o.total_sale||0).toFixed(2)}</td>
                <td>${(o.gross_profit||0).toFixed(2)}</td>
                <td>${new Date(o.created_at).toLocaleString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      // клики по строкам — открыть на редактирование
      ordersDiv.querySelectorAll('tbody tr').forEach(tr => {
        tr.addEventListener('click', async () => {
          const id = tr.getAttribute('data-id');
          const r = await fetch(`/api/orders/${id}`);
          if (!r.ok) { alert('Order not found'); return; }
          const full = await r.json();
          fillForm(full);
          showForm(true);
        });
      });
    }

    function showForm(show) {
      listSection.style.display = show ? 'none' : 'block';
      formSection.style.display = show ? 'block' : 'none';
    }

    newBtn.onclick = () => { clearForm(); showForm(true); itemsTbody.innerHTML=''; addItemBtn.click(); };
    cancelBtn.onclick = () => { clearForm(); showForm(false); };

    addItemBtn.onclick = () => itemsTbody.appendChild(row());

    saveBtn.onclick = async () => {
      const payload = getFormPayload();

      // если редактируем — PUT, если создаём — POST
      const url = editingId ? `/api/orders/${editingId}` : '/api/orders';
      const method = editingId ? 'PUT' : 'POST';

      const res = await fetch(url, {
        method,
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        showForm(false);
        clearForm();
        await loadOrders();
        alert(editingId ? 'Order updated' : 'Order saved');
      } else {
        const t = await res.text().catch(()=> '');
        alert('Error: ' + t);
      }
    };

    // первичная загрузка
    loadOrders();
  </script>
</body>
</html>
