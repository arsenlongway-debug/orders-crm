<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Orders CRM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; }
    header { padding: 16px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .container { padding: 16px; max-width: 1100px; margin: 0 auto; }
    .btn { padding: 10px 14px; border: 1px solid #ddd; border-radius: 10px; background: #fff; cursor: pointer; }
    .btn.primary { background: #0ea5e9; color: #fff; border-color: #0ea5e9; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; vertical-align: top; }
    .grid { display: grid; gap: 12px; }
    .grid.cols2 { grid-template-columns: 1fr 1fr; }
    .grid.cols3 { grid-template-columns: repeat(3, 1fr); }
    input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 8px; }
    textarea { min-height: 60px; }
    .card { border: 1px solid #eee; border-radius: 12px; padding: 16px; margin-top:12px; }
    .muted { color: #666; font-size: 12px; }
    .thumb { width: 64px; height: 64px; object-fit: cover; border-radius: 6px; border:1px solid #eee; display:block; }
    .photo-cell { display: flex; gap: 8px; align-items: center; }
    .photo-actions { display:flex; flex-direction:column; gap:6px; }
  </style>
</head>
<body>
  <header>
    <h3>Orders CRM</h3>
    <button id="newBtn" class="btn primary" type="button">+ New Order</button>
  </header>

  <div class="container">
    <section id="listSection">
      <h4>Orders</h4>
      <div id="orders"></div>
    </section>

    <section id="formSection" style="display:none;">
      <h4 id="formTitle">Create Order</h4>

      <div class="card">
        <div class="grid cols3">
          <div><label>Client</label><input id="client" /></div>
          <div>
            <label>Status</label>
            <select id="status">
              <option>New</option><option>In progress</option>
              <option>Production</option><option>Shipped</option>
              <option>Closed</option><option>Cancelled</option>
            </select>
          </div>
          <div>
            <label>Currency</label>
            <select id="currency"><option>CNY</option><option>USD</option><option>RUB</option><option>EUR</option></select>
          </div>
        </div>
        <div class="grid cols2" style="margin-top:12px;">
          <div><label>Payment Terms</label><input id="payment_terms" /></div>
          <div><label>Logistics</label><input id="logistics" /></div>
        </div>
        <div class="grid cols3" style="margin-top:12px;">
          <div><label>Planned start</label><input type="date" id="planned_start" /></div>
          <div><label>Planned end</label><input type="date" id="planned_end" /></div>
          <div><label>Actual ship</label><input type="date" id="actual_ship" /></div>
        </div>
        <div class="grid cols3" style="margin-top:12px;">
          <div><label>Order Discount %</label><input id="discount_percent" type="number" value="0" /></div>
          <div><label>Extra Costs</label><input id="extra_costs" type="number" value="0" /></div>
          <div>
            <label>WeDrive folder (URL)</label>
            <input id="wedrive_folder" placeholder="paste folder link here" />
            <div class="muted">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–∞–ø–∫—É –≤ WeDrive (LONGWAY ‚ûú Orders ‚ûú ‚Ä¶)</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h4 style="margin:0;">Items</h4>
          <button class="btn" id="addItem" type="button">+ Add item</button>
        </div>
        <table id="itemsTable">
          <thead>
            <tr>
              <th>Product</th><th>SKU</th><th>Color</th><th>Size</th>
              <th>Qty</th><th>Cost</th><th>Price</th><th>Disc %</th>
              <th>Photo</th><th>Note</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="muted">–§–æ—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Note –∫–∞–∫ <code>img:/uploads/...</code>. –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∑–∞–∫–∞–∑–∞ CRM —Å–∞–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–≤—å—é.</div>
      </div>

      <div style="margin-top:12px;">
        <button class="btn" id="cancelBtn" type="button">Cancel</button>
        <button class="btn primary" id="saveBtn" type="button">Save Order</button>
        <a id="openWeDrive" class="btn" target="_blank" style="margin-left:8px; display:none;">üìÇ Open WeDrive</a>
      </div>
    </section>
  </div>

  <script>
    let editingId = null;

    const listSection = document.getElementById('listSection');
    const formSection = document.getElementById('formSection');
    const ordersDiv = document.getElementById('orders');
    const newBtn = document.getElementById('newBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveBtn');
    const addItemBtn = document.getElementById('addItem');
    const itemsTbody = document.querySelector('#itemsTable tbody');
    const wedriveInput = document.getElementById('wedrive_folder');
    const openWeDrive = document.getElementById('openWeDrive');
    const formTitle = document.getElementById('formTitle');

    function extractImgFromNote(note='') {
      const m = note.match(/(?:^|\s)img:([^\s]+)/i);
      return m ? m[1] : '';
    }
    function putImgIntoNote(note='', url='') {
      const trimmed = (note||'').trim();
      if (!url) return trimmed.replace(/(?:^|\s)img:[^\s]+/i, '').trim();
      if (/img:[^\s]+/i.test(trimmed)) return trimmed.replace(/img:[^\s]+/i, 'img:'+url).trim();
      return (trimmed + (trimmed ? ' ' : '') + 'img:'+url).trim();
    }

    function makePhotoCell(initialUrl='') {
      const cell = document.createElement('div');
      cell.className = 'photo-cell';
      if (initialUrl) cell.dataset.photoUrl = initialUrl;

      const img = document.createElement('img');
      img.className = 'thumb';
      img.alt = 'photo';
      img.style.display = initialUrl ? 'block' : 'none';
      if (initialUrl) img.src = initialUrl;

      const actions = document.createElement('div'); actions.className = 'photo-actions';
      const file = document.createElement('input'); file.type = 'file'; file.accept = 'image/*';
      const up = document.createElement('button'); up.type='button'; up.className='btn upload-btn'; up.textContent='Upload photo';
      const rm = document.createElement('button'); rm.type='button'; rm.className='btn remove-btn'; rm.textContent='Remove';

      actions.append(file, up, rm);
      cell.append(img, actions);
      return cell;
    }

    function row(item={}) {
      const tr = document.createElement('tr');
      const photoFromNote = extractImgFromNote(item.note || '');
      tr.innerHTML = `
        <td><input value="${item.product||''}"/></td>
        <td><input value="${item.sku||''}"/></td>
        <td><input value="${item.color||''}"/></td>
        <td><input value="${item.size||''}"/></td>
        <td><input type="number" min="0" value="${item.quantity||0}"/></td>
        <td><input type="number" min="0" value="${item.cost||0}"/></td>
        <td><input type="number" min="0" value="${item.price||0}"/></td>
        <td><input type="number" min="0" value="${item.discount_percent||0}"/></td>
        <td class="photo-td"></td>
        <td><textarea>${item.note||''}</textarea></td>
        <td><button class="btn del-row" type="button">√ó</button></td>
      `;
      tr.querySelector('.del-row').onclick = () => tr.remove();
      const ptd = tr.querySelector('.photo-td');
      ptd.appendChild(makePhotoCell(photoFromNote));
      return tr;
    }

    // === –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ñ–æ—Ç–æ ===
    document.addEventListener('click', async (e) => {
      // upload
      if (e.target.classList.contains('upload-btn')) {
        const cell = e.target.closest('.photo-cell');
        const fileInput = cell.querySelector('input[type=file]');
        const img = cell.querySelector('img.thumb');
        if (!fileInput.files || !fileInput.files[0]) { alert('Choose an image'); return; }

        const fd = new FormData();
        fd.append('file', fileInput.files[0]);
        try {
          const res = await fetch('/api/upload', { method: 'POST', body: fd });
          const data = await res.json().catch(()=> ({}));
          if (res.ok && data.url) {
            cell.dataset.photoUrl = data.url;
            img.src = data.url;
            img.style.display = 'block';
            const tr = e.target.closest('tr');
            const noteEl = tr.querySelector('td:nth-child(10) textarea');
            noteEl.value = putImgIntoNote(noteEl.value || '', data.url);
            alert('Uploaded');
          } else {
            alert('Upload failed: ' + (data?.error || res.status));
          }
        } catch(err) {
          alert('Upload error: ' + (err?.message || err));
        }
      }

      // remove
      if (e.target.classList.contains('remove-btn')) {
        const cell = e.target.closest('.photo-cell');
        const img = cell.querySelector('img.thumb');
        const file = cell.querySelector('input[type=file]');
        const tr = e.target.closest('tr');
        const noteEl = tr.querySelector('td:nth-child(10) textarea');
        noteEl.value = putImgIntoNote(noteEl.value || '', ''); // —É–±—Ä–∞—Ç—å img:
        img.src = ''; img.style.display = 'none'; file.value = '';
        delete cell.dataset.photoUrl;
      }
    });

    function getFormPayload() {
      return {
        client: document.getElementById('client').value,
        status: document.getElementById('status').value,
        currency: document.getElementById('currency').value,
        payment_terms: document.getElementById('payment_terms').value,
        logistics: document.getElementById('logistics').value,
        planned_start: document.getElementById('planned_start').value,
        planned_end: document.getElementById('planned_end').value,
        actual_ship: document.getElementById('actual_ship').value,
        discount_percent: Number(document.getElementById('discount_percent').value||0),
        extra_costs: Number(document.getElementById('extra_costs').value||0),
        wedrive_folder: wedriveInput.value.trim(),
        items: Array.from(itemsTbody.querySelectorAll('tr')).map(tr=>{
          const tds = tr.querySelectorAll('td');
          const noteEl = tds[9].querySelector('textarea');
          const noteOld = noteEl.value || '';
          const photoUrl = tds[8].querySelector('.photo-cell')?.dataset?.photoUrl || '';
          const noteWithImg = putImgIntoNote(noteOld, photoUrl);
          return {
            product: tds[0].querySelector('input').value,
            sku: tds[1].querySelector('input').value,
            color: tds[2].querySelector('input').value,
            size: tds[3].querySelector('input').value,
            quantity: Number(tds[4].querySelector('input').value||0),
            cost: Number(tds[5].querySelector('input').value||0),
            price: Number(tds[6].querySelector('input').value||0),
            discount_percent: Number(tds[7].querySelector('input').value||0),
            note: noteWithImg
          }
        })
      };
    }

    function clearForm() {
      editingId = null;
      formTitle.textContent = 'Create Order';
      document.getElementById('client').value = '';
      document.getElementById('status').value = 'New';
      document.getElementById('currency').value = 'CNY';
      document.getElementById('payment_terms').value = '';
      document.getElementById('logistics').value = '';
      document.getElementById('planned_start').value = '';
      document.getElementById('planned_end').value = '';
      document.getElementById('actual_ship').value = '';
      document.getElementById('discount_percent').value = '0';
      document.getElementById('extra_costs').value = '0';
      wedriveInput.value = '';
      openWeDrive.style.display = 'none';
      itemsTbody.innerHTML = '';
      saveBtn.textContent = 'Save Order';
    }

    function fillForm(order) {
      editingId = order.id;
      formTitle.textContent = `Edit Order ${order.order_number}`;
      document.getElementById('client').value = order.client || '';
      document.getElementById('status').value = order.status || 'New';
      document.getElementById('currency').value = order.currency || 'CNY';
      document.getElementById('payment_terms').value = order.payment_terms || '';
      document.getElementById('logistics').value = order.logistics || '';
      document.getElementById('planned_start').value = order.planned_start || '';
      document.getElementById('planned_end').value = order.planned_end || '';
      document.getElementById('actual_ship').value = order.actual_ship || '';
      document.getElementById('discount_percent').value = order.discount_percent ?? 0;
      document.getElementById('extra_costs').value = order.extra_costs ?? 0;

      wedriveInput.value = order.wedrive_folder || '';
      if (wedriveInput.value) { openWeDrive.href = wedriveInput.value; openWeDrive.style.display = 'inline-block'; }
      else { openWeDrive.style.display = 'none'; }

      itemsTbody.innerHTML = '';
      (order.items || []).forEach(it => itemsTbody.appendChild(row(it)));
      if ((order.items || []).length === 0) itemsTbody.appendChild(row());
      saveBtn.textContent = 'Save Changes';
    }

    async function loadOrders() {
      const res = await fetch('/api/orders');
      const data = await res.json();
      ordersDiv.innerHTML = `
        <table>
          <thead><tr><th>#</th><th>Client</th><th>Status</th><th>Currency</th><th>Total</th><th>GP</th><th>Date</th></tr></thead>
          <tbody>
            ${data.map(o => `
              <tr data-id="${o.id}" style="cursor:pointer">
                <td>${o.order_number}</td>
                <td>${o.client||''}</td>
                <td>${o.status||''}</td>
                <td>${o.currency||''}</td>
                <td>${(o.total_sale||0).toFixed(2)}</td>
                <td>${(o.gross_profit||0).toFixed(2)}</td>
                <td>${new Date(o.created_at).toLocaleString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      ordersDiv.querySelectorAll('tbody tr').forEach(tr => {
        tr.addEventListener('click', async () => {
          const id = tr.getAttribute('data-id');
          const r = await fetch(`/api/orders/${id}`);
          if (!r.ok) { alert('Order not found'); return; }
          const full = await r.json();
          fillForm(full);
          showForm(true);
        });
      });
    }

    function showForm(show) {
      listSection.style.display = show ? 'none' : 'block';
      formSection.style.display = show ? 'block' : 'none';
    }

    newBtn.onclick = () => { clearForm(); showForm(true); itemsTbody.innerHTML=''; itemsTbody.appendChild(row()); };
    cancelBtn.onclick = () => { clearForm(); showForm(false); };

    wedriveInput.addEventListener('input', () => {
      const v = wedriveInput.value.trim();
      if (v) { openWeDrive.href = v; openWeDrive.style.display = 'inline-block'; }
      else { openWeDrive.style.display = 'none'; }
    });

    saveBtn.onclick = async () => {
      const payload = getFormPayload();
      const url = editingId ? `/api/orders/${editingId}` : '/api/orders';
      const method = editingId ? 'PUT' : 'POST';

      const res = await fetch(url, {
        method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });

      if (res.ok) {
        showForm(false);
        clearForm();
        await loadOrders();
        alert(editingId ? 'Order updated' : 'Order saved');
      } else {
        const t = await res.text().catch(()=> '');
        alert('Error: ' + t);
      }
    };

    loadOrders();
  </script>
</body>
</html>
